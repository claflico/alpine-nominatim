alpine-nominatim
==============

This image is a self-contained Nominatim server comprised of alpine, nginx, Nominatim, php-fpm, postgresql, & supervisord.

## Build

```
docker build -t claflico/alpine-nominatim:<version> .
```

## Versions

- `3.4.2-0` [(Dockerfile)](https://github.com/claflico/alpine-nominatim/blob/3.4.2-0/Dockerfile)

## Instructions

1. Launch a container with mounted volumes (/opt/nominatim/data & /var/lib/postgresql/data) and environment variables NOMINATIM_SETUP_ENABLE=true and NOMINATIM_PBF_(PLANET|CONTINENT|_ENABLE=true
2. Wait for initial download & import of PBF file (this can take a day or more depending upon PBF file).
3. Shutdown container and relaunch with NOMINATIM_SETUP_ENABLE=false.

## Configuration

The image runs with default or recommended configurations but can be highly customized through env variables.

### Nginx Configuration

|                                                        |                                                                                                                             |
|--------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `NGINX_HTTP_PORT=80`                                   | http port                                                                                                                   |
| `NGINX_HTTPS_ENABLE="false"`                           | "true" enables https and http listeners. "only" enables https listener and redirect http to https.                          |
| `NGINX_HTTPS_PORT=443`                                 | https port                                                                                                                  |
| `NGINX_KEEPALIVE_TIMEOUT="65"`                         | The number of seconds the server will wait before closing a keep-alive connection.                                          |
| `NGINX_SENDFILE="on"`                                  | Eliminates the step of copying the data into the buffer and enables direct copying data from one file descriptor to another |
| `NGINX_SSL_CIPHERS="HIGH:!aNULL:!MD5"`                 | The enabled ciphers specified in the format understood by the OpenSSL library                                               |
| `NGINX_SSL_DIR="/etc/nginx/ssl"`                       | Directory to .key and .crt files                                                                                            |      
| `NGINX_SSL_CRT_FILE="${NGINX_SSL_DIR}"/nominatim.crt"` | Default crt file.                                                                                                           |
| `NGINX_SSL_KEY_FILE="${NGINX_SSL_DIR}"/nominatim.key"` | Default key file.                                                                                                           |
| `NGINX_SSL_PROTOCOLS="TLSv1 TLSv1.1 TLSv1.2"`          | Enables the specified protocols.                                                                                            |
| `NGINX_WORKER_CONNECTIONS="1024"`                      | The maximum number of connections that each worker process can handle simultaneously.                                       |
| `NGINX_WORKER_PROCESSES=${CPU_COUNT}`                  | The number of worker processes. Defaults to CPU count.                                                                      |

### Nginx SSL Configuration

Added SSL configuration. Set `NGINX_HTTPS_ENABLE="< true || only >"` to enable it.

Self-signed SSL certificates are generated by default in `/etc/nginx/ssl`.
You need to provide `nominatim.key` AND `nominatim.crt` files in that directory or override NGINX_SSL_CRT_FILE & NGINX_SSL_KEY_FILE env variables to use a CA-signed certificate.


### PHP-FPM Configuration

|                                        |                                                                                                                                                                 |
|----------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `PHPFPM_CATCH_WORKERS_OUTPUT="yes"`    | Redirect worker stdout and stderr into main error log.                                                                                                          |
| `PHPFPM_CLEAR_ENV="no"`                | Prevents arbitrary environment variables from reaching FPM worker processes by clearing the environment in workers before env vars are added.                   |
| `PHPFPM_DECORATE_WORKERS_OUTPUT="no`   | Enable the output decoration for workers output when `PHPFPM_CATCH_WORKERS_OUTPUT` is enabled.                                                                  |
| `PHPFPM_LISTEN="127.0.0.1:9000"`       | The address on which to accept FastCGI requests.                                                                                                                |
| `PHPFPM_MAX_CHILDREN="100"`            | Number of child processes to create when `PHPFPM_PROCESS_MANAGER="static"` and max number of child processes to create when `PHPFPM_PROCESS_MANAGER="dynamic"`. |
| `PHPFPM_MAX_REQUESTS="1000"`           | The number of requests each child process should execute before respawning.                                                                                     |
| `PHPFPM_PING_PATH="/fpm-ping"`         | The ping URI to call the monitoring page of FPM. Also used in nginx configuration.                                                                              |      
| `PHPFPM_PING_STATUS_ALLOW="127.0.0.1"` | Default crt file.                                                                                                                                               |
| `PHPFPM_PROCESS_IDLE_TIMEOUT="10s"`    | The number of seconds after which an idle process will be killed. Used only when `PHPFPM_PROCESS_MANAGER="ondemand"`.                                           |
| `PHPFPM_PROCESS_MANAGER="ondemand"`    | Choose how the process manager will control the number of child processes. Possible values: <code>static&vert;ondemand&vert;dynamic</code>                      |
| `PHPFPM_STATUS_PATH="/fpm-status"`     | The URI to view the FPM status page. Also used in nginx configuration.                                                                                          |

### Postgresql Configuration

|                                               |                                                                                               |
|-----------------------------------------------|-----------------------------------------------------------------------------------------------|
| `POSTGRES_AUTOVACUUM_WORK_MEM="2GB"`          | Nominatim install docs suggests 2GB                                                           |
| `POSTGRES_CHECKPOINT_COMPLETION_TARGET="0.9"` | Nominatim install docs suggests 0.9, postgresql suggests maximum of 0.9                       |
| `POSTGRES_CHECKPOINT_TIMEOUT="10min"`         | Nominatim install docs suggests 10min                                                         |
| `POSTGRES_EFFECTIVE_CACHE_SIZE="8GB"`         | Nominatim install docs suggests 24GB, postgresql suggests 50% of total memory                 |
| `POSTGRES_MAINTENANCE_WORK_MEM="10GB"`        | Nominatim install docs suggests 10GB, postgresql suggests 2X or more than `POSTGRES_WORK_MEM` |
| `POSTGRES_MAX_WAL_SIZE="1GB"`                 | Nominatim install docs suggests 1GB                                                           |
| `POSTGRES_SHARED_BUFFERS="2GB"`               | Nominatim install docs suggests 2GB, postgresql suggests 25% of total memory                  |
| `POSTGRES_SYNCHRONOUS_COMMIT="off"`           | Nominatim install docs suggests off                                                           |
| `POSTGRES_WORK_MEM="50MB"`                    | Nominatim install docs suggests 50MB                                                          |

## TODO

- Test connectivity to external postgresql database server.
- Add Planet PDF update capability.
- Resolve Nominatim Flatnode_File issue.