alpine-nominatim
==============

This image is a self-contained Nominatim server comprised of alpine, nginx, Nominatim, php-fpm, postgresql, & supervisord.

## Build

```
docker build -t claflico/alpine-nominatim:<version> .
```

## Versions

- `3.4.2-0` [(Dockerfile)](https://github.com/claflico/alpine-nominatim/blob/3.4.2-0/Dockerfile)

## Instructions

1. Launch a container with mounted volumes (/opt/nominatim/data & /var/lib/postgresql/data) and environment variables NOMINATIM_SETUP_ENABLE=true and NOMINATIM_PBF_(PLANET|CONTINENT|_ENABLE=true
2. Wait for initial download & import of PBF file (this can take a day or more depending upon PBF file).
3. Shutdown container and relaunch with NOMINATIM_SETUP_ENABLE=false.

## Configuration

The image runs with default or recommended configurations but can be highly customized through env variables.

### Nginx Configuration

|                                                        |                                                                                                                             |
|--------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `NGINX_HTTP_PORT=80`                                   | http port                                                                                                                   |
| `NGINX_HTTPS_ENABLE="false"`                           | "true" enables https and http listeners. "only" enables https listener and redirect http to https.                          |
| `NGINX_HTTPS_PORT=443`                                 | https port                                                                                                                  |
| `NGINX_KEEPALIVE_TIMEOUT=65`                           | the number of seconds the server will wait before closing a keep-alive connection                                           |
| `NGINX_SENDFILE=on`                                    | Eliminates the step of copying the data into the buffer and enables direct copying data from one file descriptor to another |
| `NGINX_SSL_CIPHERS=HIGH:!aNULL:!MD5`                   | The enabled ciphers specified in the format understood by the OpenSSL library                                               |
| `NGINX_SSL_DIR="/etc/nginx/ssl"`                       | Directory to .key and .crt files                                                                                            |      
| `NGINX_SSL_CRT_FILE="${NGINX_SSL_DIR}"/nominatim.crt"` | Default crt file.                                                                                                           |
| `NGINX_SSL_KEY_FILE="${NGINX_SSL_DIR}"/nominatim.key"` | Default key file.                                                                                                           |
| `NGINX_SSL_PROTOCOLS=TLSv1 TLSv1.1 TLSv1.2`            | Enables the specified protocols.                                                                                            |
| `NGINX_WORKER_CONNECTIONS=1024`                        | The maximum number of connections that each worker process can handle simultaneously.                                       |
| `NGINX_WORKER_PROCESSES=CPU_COUNT`                     | The number of worker processes. Defaults to CPU count.                                                                      |

### SSL Configuration

Added SSL configuration. Set `NGINX_HTTPS_ENABLE="< true || only >"` to enable it.

Self-signed SSL certificates are generated by default in `/etc/nginx/ssl`.
You need to provide `nominatim.key` AND `nominatim.crt` files in that directory or override NGINX_SSL_CRT_FILE & NGINX_SSL_KEY_FILE env variables to use a CA-signed certificate.

## TODO

- Test connectivity to external postgresql database server.
- Add Planet PDF update capability.
- Resolve Nominatim Flatnode_File issue.